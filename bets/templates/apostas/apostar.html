{% extends 'base.html' %}

{% block title %}Apostar - PalpitaIFPI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/criar_palpite.css">
{% endblock %}

{% block content %}
<div class="aposta-container">
    <h2>üí∞ Fazer Aposta</h2>

    <div class="aposta-info-box">
        <h3>{{ jogo.time1 }} x {{ jogo.time2 }}</h3>
        <p><strong>Modalidade:</strong> {{ jogo.modalidade.nome }}</p>
        <p><strong>Data/Hora:</strong> {{ jogo.data|date:"d/m/Y H:i" }}</p>
        <p>
            <strong>Seu XP:</strong> <strong class="xp-green">{{ perfil.xp }} XP</strong> 
            | 
            <strong>N√≠vel:</strong> {{ perfil.nivel }}
        </p>
    </div>

    <form method="post" class="bg-f8f9fa">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="tipo_aposta">Tipo de Aposta:</label>
            <select name="tipo_aposta" id="tipo_aposta" onchange="mostrarMercado()" required>
                <option value="">Selecione...</option>
                <option value="1X2">Resultado 1X2</option>
                <option value="PLACAR">Placar Exato</option>
            </select>
        </div>
        
        <div id="mercado_1x2" class="mercado-box" style="display: none;">
            <h4>Escolha o Resultado:</h4>
            <div class="mercado-flex">
                <label class="mercado-label">
                    <input type="radio" name="aposta_1x2" value="1" required>
                    <strong>{{ jogo.time1 }}</strong><br>
                    <span class="odd-chip">{{ jogo.odd_time1 }}</span>
                </label>
                <label class="mercado-label">
                    <input type="radio" name="aposta_1x2" value="X" required>
                    <strong>Empate</strong><br>
                    <span class="odd-chip">{{ jogo.odd_empate }}</span>
                </label>
                <label class="mercado-label">
                    <input type="radio" name="aposta_1x2" value="2" required>
                    <strong>{{ jogo.time2 }}</strong><br>
                    <span class="odd-chip">{{ jogo.odd_time2 }}</span>
                </label>
            </div>
        </div>
        
        <div id="mercado_placar" class="mercado-box" style="display: none;">
            <h4>Placar Exato (Odd: <span class="odd-chip">{{ jogo.odd_placar_exato }}</span>)</h4>
            <div class="mercado-flex-center">
                <div class="form-group mercado-form-flex">
                    <label for="palpite_time1">{{ jogo.time1 }}</label>
                    <input type="number" id="palpite_time1" name="palpite_time1" min="0" value="0" required>
                </div>
                <div class="x-bold">x</div>
                <div class="form-group mercado-form-flex">
                    <label for="palpite_time2">{{ jogo.time2 }}</label>
                    <input type="number" id="palpite_time2" name="palpite_time2" min="0" value="0" required>
                </div>
            </div>
        </div>
        
        <div class="form-group mt-30">
            <label for="valor_apostado">Valor da Aposta (R$):</label>
            <input type="number" 
                   id="valor_apostado" 
                   name="valor_apostado" 
                   min="1" 
                   step="0.01" 
                   value="10.00" 
                   required
                   oninput="calcularGanho()">
            <small class="valor-min" style="color: var(--text-muted);">Valor m√≠nimo: R$ 1,00</small>
        </div>
        
        <div id="ganho_potencial" class="ganho-potencial-box" style="display: none;">
            <strong>Ganho Potencial:</strong> <span id="ganho_valor" class="ganho-green">R$ 0,00</span>
        </div>
        
        <div class="mt-30" style="display: flex; gap: 10px;">
            <button type="submit" class="btn" style="flex: 1;">Confirmar Aposta</button>
            <a href="{% url 'listar_jogos' %}" class="btn btn-secondary ml-10">Cancelar</a>
        </div>
    </form>
    
    <script>
    function mostrarMercado() {
        const tipo = document.getElementById('tipo_aposta').value;
        document.getElementById('mercado_1x2').style.display = tipo === '1X2' ? 'block' : 'none';
        document.getElementById('mercado_placar').style.display = tipo === 'PLACAR' ? 'block' : 'none';
        calcularGanho();
    }
    function calcularGanho() {
        const tipo = document.getElementById('tipo_aposta').value;
        const valor = parseFloat(document.getElementById('valor_apostado').value) || 0;
        const ganhoDiv = document.getElementById('ganho_potencial');
        const ganhoValor = document.getElementById('ganho_valor');
        if (tipo && valor > 0) {
            let odd = 0;
            if (tipo === '1X2') {
                const selecionado = document.querySelector('input[name="aposta_1x2"]:checked');
                if (selecionado) {
                    // Nota: '{{ jogo.odd_time1 }}' √© uma string e deve ser convertida
                    if (selecionado.value === '1') odd = Number('{{ jogo.odd_time1 }}');
                    else if (selecionado.value === 'X') odd = Number('{{ jogo.odd_empate }}');
                    else if (selecionado.value === '2') odd = Number('{{ jogo.odd_time2 }}');
                }
            } else if (tipo === 'PLACAR') {
                // Nota: '{{ jogo.odd_placar_exato }}' √© uma string e deve ser convertida
                odd = Number('{{ jogo.odd_placar_exato }}');
            }
            if (odd > 0) {
                const ganho = valor * odd;
                ganhoValor.textContent = 'R$ ' + ganho.toFixed(2);
                ganhoDiv.style.display = 'block';
            } else {
                ganhoDiv.style.display = 'none';
            }
        } else {
            ganhoDiv.style.display = 'none';
        }
    }
    document.getElementById('valor_apostado').addEventListener('input', calcularGanho);
    document.querySelectorAll('input[name="aposta_1x2"]').forEach(radio => {
        radio.addEventListener('change', calcularGanho);
    });
    // Garante que o c√°lculo seja feito ao carregar a p√°gina se o mercado j√° estiver selecionado
    document.addEventListener('DOMContentLoaded', mostrarMercado);
    </script>
</div>
{% endblock %}